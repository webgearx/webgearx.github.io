<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>WEBGEARX</title>
  <script type="module">
    // Import the functions you need from the SDKs you need
    import {initializeApp} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {getDatabase, ref, set, get, child} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import {getAnalytics} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider ,onAuthStateChanged} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries

    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
      apiKey: "AIzaSyAz_dRO7S0Tr_kyZhPHpyPnQSLPzUMtfEY",
      authDomain: "webgearx-e4a64.firebaseapp.com",
      projectId: "webgearx-e4a64",
      storageBucket: "webgearx-e4a64.appspot.com",
      messagingSenderId: "1017438168920",
      appId: "1:1017438168920:web:b873248d29dc3f62c6a72d",
      measurementId: "G-HL4651KN0X"
    };
    console.error = alert
    const queryString = window.location.search;
    const href = window.location.href
    const urlParams = new URLSearchParams(queryString);
    var show = document.getElementById("show")
    var uid = "None"

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const database = getDatabase();
    var user = "None"
    const auth = getAuth();
    const provider = new GoogleAuthProvider();
    if (!urlParams.get('id')){
      signInWithPopup(auth, provider)
        .then((result) => {
        // This gives you a Google Access Token. You can use it to access the Google API.
        const credential = GoogleAuthProvider.credentialFromResult(result);
        const token = credential.accessToken;
        // The signed-in user info.
        const user = result.user;
        document.getElementById("bodydiv").innerHTML = "Username:" + user.displayName + "<br>" + document.getElementById("bodydiv").innerHTML
        // IdP data available using getAdditionalUserInfo(result)
        uid = user.uid
        // ...
      }).catch((error) => {
        // Handle Errors here.
        const errorCode = error.code;
        const errorMessage = error.message;
        // The email of the user's account used.
        const email = error.customData.email;
        // The AuthCredential type that was used.
        const credential = GoogleAuthProvider.credentialFromError(error);
        // ...
      });
      user = auth.currentUser;
    }
    onAuthStateChanged(auth, (user) => {
      if (user) {
        // User is signed in, see docs for a list of available properties
        // https://firebase.google.com/docs/reference/js/auth.user
        alert("Welcome to WEBGEARX")
        document.getElementById("bodydiv").style = ""
        // ...
      } else {
        // User is signed out
        // ...
        alert("please sign in to continue!")
        document.getElementById("bodydiv").style = "display:None;"
      }
    });
    if (user != "None") {
      // User is signed in, see docs for a list of available properties
      // https://firebase.google.com/docs/reference/js/auth.user
      // ...
      alert("Welcome to WEBGEARX")
      document.getElementById("bodydiv").style = ""
    } else {
      alert("please sign in to continue!")
      document.getElementById("bodydiv").style = "display:None;"
    }
    if (urlParams.get('id')) {
      get(ref(database, `page/${urlParams.get('id')}`)).then((snapshot) => {
        if (snapshot.exists()) {
          document.title = urlParams.get('id')
          show.innerHTML = snapshot.val().value
          show.style = ""
          document.getElementById("bodydiv").style = 'display: none'
        } else {
          console.log("No data available");
        }
      }).catch((error) => {
        console.error(error);
      });
    }
    var upload = function () {
      var name = document.getElementById("name").value
      var code = document.getElementById("htmlcode").value
      get(ref(database, 'page/' + name)).then((snapshot) => {
        if (!snapshot.exists()) {
          const d = new Date();
          let text = d.toTimeString();
          set(ref(database, 'page/' + name), {value: code, owner: uid, last: text});
          alert("uploaded")
          document.getElementById("bodydiv").innerHTML += "<br>"
          document.getElementById("bodydiv").innerHTML += window.location.href
          document.getElementById("bodydiv").innerHTML += "?id=" + name
          get(ref(database, 'user/' + uid)).then((snapshot) => {
            var dataget
            if (snapshot.exists()){
              dataget = snapshot.val()
            }else{
              dataget = {}
            }
            dataget[name] = "plaintext"
            set(ref(database, 'user/' + uid),dataget)
          })
        } else {
          if (snapshot.val().owner == uid){
            
            set(ref(database, 'page/' + name), {value: code, owner: uid});
            alert("updated")
            document.getElementById("bodydiv").innerHTML += "<br>"
            document.getElementById("bodydiv").innerHTML += window.location.href
            document.getElementById("bodydiv").innerHTML += "?id=" + name
          }
        }
      }).catch((error) => {
        console.error(error);
      });
      
    }
    var uploadbt = document.getElementById("upload")
    uploadbt.onclick = upload
    function updatepages(){
      var data
      get(ref(database, 'user/' + uid)).then((snapshot) => {
        if (!snapshot.exists()){
          data = {}
        }else{
          data = snapshot.val()
        }
        var innerhtml = ""
        for (var i = 0; i < Object.keys(data).length;i++){
          get(ref(database, 'page/' + Object.keys(data)[i])).then((snapshot) => {
            var page = snapshot.val()
            innerhtml += "<br>"
            innerhtml += "Item " + i + ":<br>"
            innerhtml += "Name: " + Object.keys(data)[i] + "<br>"
            innerhtml += "Size: " + page.value.length / 1024 + "kb" + "<br>"
            innerhtml += "LastEdit: " + page.last + "<br>"
            innerhtml += '<button onclick="copy(' + Object.keys(data)[i] + ')">' + "EDIT</button>"
          })
        }
        
        document.getElementById("yourpage").innerHTML = innerhtml
      })
      
    }
  </script>
</head>

<body>
  <div id="bodydiv">
    name:<input id="name"></input><br>
    code:<input id="htmlcode"></input><br>


    <button id="upload">upload</button>
  </div>
  <div id="yourpage">
    
  </div>
  <div id="show" style="display:none;"></div>
</body>

</html>
